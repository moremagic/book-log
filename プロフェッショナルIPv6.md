# プロフェッショナル IPv6 読書メモ

## DL
https://professionalipv6.booth.pm/items/913273


# 序文

- IPv6 基本仕様（RFC1883） 1995年発行だがなかなか移行が進まなかった
- 2011年 IPv4 枯渇。急激に移行が進む
- IPv6 のまとまった情報が少なかった
- 多くのエンジニアに向けてまとまった情報を提供することも目指し書かれた

## 混ざりつつも、似て非なるプロトコル

- IPv4と IPv6は全く違うプロトコルで別々のネットワーク
- しかしIPv4とIPv6 は同じ物理回線やサーバを共有するのが一般的
- 一つのインターネットと言う考えから部分的には意図的に（仕様が？）混ざっている
  - DNSなど
- 似て非なる部分を明確にし、平行運用されるデュアルスタック環境についても解説する

## 背景や経緯の説明

- RFCは誰でも読める形で公開されているが背景や経緯についての言及が無いこともある
- RFC を読むだけではわからない部分を補う
- IPv6 は標準化された当初から中身が関わり続けているため背景を知ると理解しやすい

## 無償配布

- PDFを無償配布（CCC:BY-NC-SA）
- IPv6 への情報アクセスを容易にし運用上の問題を防ぎたい

## 本書の構成

（割愛）

# 本書を読むにあたっての前提知識

- インターネットの仕組みとIPv6についておさらい
- IPv4とIPv6が共存するデュアルスタック環境の鍵となるDNSについて解説
- NAT64,DNS64概要を紹介

## 第一章 インターネット概要

- インターネット；ネットワーク同士をつないだもの
- プロトコル（protocol）；相互通信するための送受信の決まり
- IP；インターネットプロトコル
- IPv6；インターネットプロトコル バージョン６
- IPv4 の枯渇を防ぐ： NAT、CIDR、プライベートIP
− IPv6 はIPアドレス空間をオキクして枯渇を解決するよ！

### 1.1 IPはパケット交換技術

- 回線交換方式：片方が通話中は待っていることしかできない
− パケット交換方式；パケットを小さくすることで回線専有時間を短く
- 回線交換方式からパケット交換方式へ
− パケット；小包

#### 1.1.1 IPパケットフォーマット

- パケットのデータを表現する型；フォーマット
- パケットには ヘッダとペイロードがある
- バイトオーダー：ビットの並べ方
  - ビッグエンディアン（MSBから並べる)とリトルエンディアン；ガリバー旅行記
  - MSB；MostSignificantBit　メモリアドレスが大きいほう
  - LSB；LeastSignificantBit　小さい方
  - ネットワークバイトオーダ、ホストバイトオーダー
- 物理層の通り方は決まってない
- ネットワークバイトオーダは ビッグエンディアン

#### 1.1.2 IPパケットを転送するルータ

- ルータ（route）；IPパケットを転送する機器
- ルータはルーティングテーブルを持つ
- パケットのヘッダに書いてある宛先を見て ルーティングテーブルに従って転送
- それだけで目的地に届くのね

#### 1.1.3 ルータ、ホスト、ノード

- 用語整理
  - ノード：接点。ルータ
  - ホスト: ネットワークの末端。ルーターではないノード（RFC8200)
　
#### 1.1.4 IPアドレスの構成

- IPアドレスの集合体；ネットワーク、サブネット
- ルーティングテーブル；経路情報、サブネット
- IPアドレスの表現
  - IPv4アドレス；前半部を ネットワーク部、後半部を ホスト部
  - IPv6アドレス；前半部を ネットワーク部、後半部を インターフェース識別値
- ネットマスク
  - ビット演算 AND （両方共１だと １）
  - ネットワークアドレスを計算する

#### 1.1.5 プレフィックス長
- 先頭から何ビット１かを表すことでネットワークアドレスを表現する方法

#### 1.1.6 ルーティングテーブルはどのように生成されているか
- フォワーディング；ルータがルーティングテーブルに従ってパケットを転送すること
- トポロジ；ネットワーク構成やネットワーク全体の形状のこと
- デフォルトルータ
  - 標準の通信先。ルータ（ゲートウェイ）のこと
  - デフォルトゲートウェイ

- ルーティングテーブルはどうやって作るか
  - 人間による手作業
  - ルータ同士が協調して自動生成（ルーティングプロトコル）

- ルーティング・プロトコル
  - 各組織内ネットワーク
    - ディスインスペクタ型（ルータが近くにある機器を伝言ゲームで伝える）
      - RIP（RoutingInfomationProtocol): IPv4のみで使用可能
      - RIPng: RIPv2 IPv6拡張版
    - リンクステート型（周囲の機器一覧をすべてのルータと共有する）
      - OSPF(OpenShortestPathFirst)
        - OSPFv2:IPv4；サブネット単位でルーティングテーブルを計算
        - OSPFv3: RFC5340、RFC5838 IPv4,IPVv6両方で使えるようになった
      - IS-IS(IntermediateSystem to Intermediate System)
      - リンクステート型は大規模ネットワークでは現実的ではない
  - 組織間ネットワーク
    - 組織ネットワークを AS（AutonomousSystem）自律システム という単位で管理
    - AS間 の経路制御を行う
    - BGP（BorderGatwayProtocol）
      - BGP4 IPv4用
      - BGP4+（RFC4760） IPv4、IPv6に対応

### 1.2 層に別れるネットワーク

- インターネット階層モデル
  - 4層
    - アプリケーション層
    - トランスポート層
      - TCP, UDP
    - ネットワーク層
      - IP？、ICMP？
    - リンク層
      - ARP？

  - OSI参照モデルとは違うみたい
     - https://ja.wikipedia.org/wiki/OSI%E5%8F%82%E7%85%A7%E3%83%A2%E3%83%87%E3%83%AB

#### 1.2.1 階層構造とパケット

- 各層ごとにパケットが入れ子になってる

#### 1.2.2 イーサネットにおける違い

- IPv4、IPv6の違い
  - トランスポート層ヘッダ；Protocol、NextHeader
  - リンク層ヘッダ；タイプフィールド、マルチキャストアドレス

### 1.3 トランスポート層の役割

- ネットワークはパケットを運ぶだけで到達保証はしない
- トランスポート層（TCP）でパケットの到達保証をする
  - 再送制御、順序保証
  - IPv4、IPv6で同じように使える

- UDP は カスタム用プロトコル
  - プログラマが自分で必要な機能を実装するためのプロトコル
  - TCP みたいに頑張らない

### 1.4 オープンなプロトコルとRFC

- 通信の約束事を決めたのがプロトコル

#### 1.4.1 インターネットのプロトコルはオープン

- インターネットを利用した通信プロトコルはすべてオープン

#### 1.4.2  オープンな仕様としてのRFC

- TCP/IPについての仕様はIETF（InternetEnginneringTaskForce）で議論されている
- 議論された結果は文書として公開される→ RFC（RequestForComments)
- RFCはブランド。

- 規格標準化団体 の違い
  - デジュールスタンダード（法律上の。作る）
    - ITU（InternationalTelecommunicationUnion）国際電気通信連合
    - ISO（InternationalOganaization for Standardization）国際標準
  - デファクトスタンダード（事実上の。議論する）
    - IFTF

#### 1.4.3 RFCには何が書かれているか

- RFCの種類
  - StandardTrack；標準を目指す文書
  - Infomational；参考情報（JokeRFCはここに含まれる）
  - Exprerimental；実験的な試み
  - Historic；歴史的経緯（非推奨）
  - BestCurrentPractice；その時点における最良の方法

- RFCに書かれていてもそのままの形で実装されるとは限らない

#### 1.4.4 IFTF以外からのRFC

- IFTF以外でRFCが作られることがある（RFC4844）
  - IFTFストリーム
  - IABストリーム（RFC4845）
  - IRTFストリーム（RFC5742）
  - 個人による投稿からのストリーム（RFC4846）

#### 1.4.5 RFCの廃止や更新

- 一度発行されたRFCは内容を変更することができない
- 別のRFCで内容更新されたり、廃止されることがある


#### 1.4.6 番号と名前を管理するIANA

- IANA（InternetAssignedNumbersAuthority）
- インターネットで利用する番号や名前などの資源を統一的に管理する組織
- 資源の種類
  - ドメイン名に関する情報
  - 番号資源（IP、AS）
  - プロトコルパラメータ

## 第二章 IPv6でインターネットはどう変わるか

- IPv6 はIPv4と似ているがいろいろ異なる
- IPv4 と IPv6の相違点を概観してから整理していきましょう

### 2.1 IPv6とIPv4の違い

- IPアドレス長の違い
  - IPv4；32ビット, ドット区切り
  - IPv6；128ビット、コロン区切り
- IPアドレス構成要素
  - IPv4；ネットワーク部とホスト部
  - IPv6；サブネットプレフィックスとインターフェース識別子
- アドレスフォーマットの利用方法が多彩に
  - IPv6；スコープ、マルチキャストアドレス、IPv4アドレス埋め込み
- ICMPの役割の違い
  - IPv4；ARP,IGMP
  - IPv6；近隣探索プロトコルへ統合 
  - ICMP -> ICMPv6
- 複数IPアドレスを一つのネットワークインターフェースに
  - IPv4；NICとIP は一対一
  - IPv6；NICに複数のIPを指定できる
- IPアドレスの設定、運用方法の違い
  - DHCP -> DHCPv6
  - SLAAC(StateLessAddressAutoConfigration）
  - IPを割り当てるのではなくネットワークプレフィックスを割り当てられるのが一般的
    - DHCPv6-PD
- ヘッダフォーマットの違い
  - ヘッダのフォーマットが大きく違う
- フラグメンテーションの違い
  - IPV6拡張ヘッダでフラグメンテーションを行う
  - IPv6では経路の途中でフラグメンテーションができない
    - ルータ側で MTUより大きいとパケットを破棄する
   - MTUが重要
     - IPv4では多少大きすぎてもルータが分割してくれてた
- ブロードキャストからマルチキャストへ
  - IPv6ではブロードキャストが廃止。マルチキャストで行う
  - 送信するアドレスが多すぎて 問題が起きないようにかな？


### 2.2 IPv6対応とは

- 移行ではなく対応
  - IPv4を中心に運用されてきた
  - IPv4 と IPv6 の混在環境での運用を考慮する必要がある

- IPv6 対応の具体的な対応箇所
  - ネットワークの IPv6対応
  - ユーザの IPv6対応
  - サーバの IPv6対応
  - アプリケーションの IPv6対応

#### 2.2.1 ネットワークのIPv6対応

- IPv6通信プロトコルの対応と、IPv6インターネット接続は別

#### 2.2.2 ユーザのIPv6対応

- ユーザの機器がIPv6に対応しているか
- ユーザの機器でIPv6が有効になっているか
  - デフォルト設定がIPv6になっているかでIPv6が使われるかどうかがほぼ決まる
- ネットワーク機器がIPv6に対応しているか（ルータとかかな？
- 契約回線がIPv6対応しているか

#### 2.2.3 アプリケーションのIPv6対応

- アプリケーションレベルでIPv6対応が必要
- 使用するアプリケーションがIPv6に対応している事が重要
- 対応時の注意点
  - IPv4に対応しつつ完全なIPv6バージョンを提供するのは難しい
  - IPアドレス記法の差
  - 送信元IPv6アドレスが必要な場合もある（？
  - マルチキャストを使うアプリはIPv4との違いに注意
  - APIの違い

#### 2.2.4 サーバのIPv6対応

- IPv6アドレスは DNS AAAAレコードに登録する
- 通信を開始するアプリケーションがIPv4を使うかIPv6を使うかを決める

### 2.3 IPv6インターネットとIPv4インターネットを同時に使う

- 同時に運用するときに重要な名前解決について解説

#### 2.3.1 IPv6　と IPv4 のデュアルスタック

- プロトコルスタック；特定のプロトコルを扱うためのソフトウェア実装
- 全く別なプロトコルスタックを使える状態；デュアルスタック
- デュアルスタック環境を意識する場面は増えていくでしょう

#### 2.3.2 DNSの役割

- デュアルスタックになってもインターネットは一つである
- これを実現するのがDNS

- DNS；名前からIPアドレスを引く
  - IPv4; Aレコード
  - IPv6；AAAAレコード（クアッドAと呼ぶ）

#### 2.3.3 IPv4 と IPv6 のどちらを使うのか判断するのはユーザ側

- 名前解決は両方でできるようにしておく
- どちらの名前で解決するかはユーザ側が決める
- アプリケーションの対応
  - IPv4を使うのかIPv6を使うのかを判断するプログラムをかくことが推奨されている

### 2.4 IPv6ネットワークからIPv4ネットワークに接続する


- IPv6 シングルスタックにすると IPv4ネットワークと通信できない
- 共存させる手法がある
  - NAT64+DNS64
  - 異なる技術だけどセットで使われる

- NAT64；IPv6ヘッダ <-> IPv4ヘッダ 変換
- DNS64；IPv4「名前」をIPv6で使用できるようにする

#### 2.4.1 NAT64 と SIIT

- IPv4と IPv6 は異なるヘッダを持っているため通信時には変換が必要
- 変換可能な方法を定義した SIIT（RFC7915）
- 変換方法；ステートフル、ステートレス
- NAT64トランスレータ；XLAT

- IPアドレス変換（例）
  - IPv4 ； 192.0.2.23 
  - IPv6 ； 64:ff9b::192.0.2.23/96 

#### 2.4.2 DNS64

- IPv4ホストを名前解決するとき IPv6で返してあげる
- DNS で IPv4 の名前解決時にIPv6変換して返してあげる
  - IPからIP変換をしてかえしてるみたい
  - IPv4 を名前として取り扱ってるイメージなのかな

#### 2.4.3 NAT64+DNS64

- DNS64 IPv6 で すべてのアドレスを返す
  - IPv6 の場合そのまま
  - IPV4 の場合 変換して返す

- IPv6トラフィックはそのままIPv6インターネットを使用して通信を行う
- IPv4トラフィックは NAT64 で IPv4変換されて IPv4インターネット通信を行う


## 第3章 IPv6アドレスとそのテキスト表記

- IPv6 アドレス長 は128 ビット

### 3.1 IPv6 アドレス空間

-  1ビット増やすたびに 2倍 のアドレス空間となる
  - 32bitが 128bit になったということは・・・
  -  2^（128−32）倍 になったということ

#### 3.1.1 実際に使えるIPv6アドレス空間

- 128bit 全部使えるわけじゃない
  - 上位 64bitは ネットワークアドレスとして利用される
  - 残りの 64bit で表現可能な個数が各ネットワーク内で使用できる
  - １つのネットワーク内で使用できるIPが 32bit の 2^32倍になる
- たくさんはあるけど無限じゃないよね

### 3.2 IPv6 アドレスのテキスト表記

- IPv4
  - 32bit, 8bit区切り、10進数、ドット区切り
    - ex) 1100000.00000000.00000010.00000001
    - ex) 192.0.2.1
- IPv6
  - 128bit, 16bit区切り、16進数、コロン（:）区切り、省略記法有
    - ex) 2001:0db8:11aa:22bb:33cc:44dd:55ee:66ff
    - ex) 2001:.... == 00100000 00000001:....


#### 3.2.1 IPv6のアドレス体型を規定したRFC

- IPv6はどんどん仕様が改定されている
- 勉強した時期によって知識のアップグレードが必要
  - RFC1884(1995年)
  - RFC2373(1998年)
  - RFC3513(2003年)
  - RFC4291(2006年) ※安定してる

### 3.3 IPv6アドレスの省略表記

#### 3.3.1 RFC4291の表記ルール

- 複数の表記方法が存在する（RFC4291)
- 表記方法の統一ルール（RFC5952) が発行されている
- RFC4291ルール
  - 16bitずつ区切った16新表記の先頭0は省略できる
    - 元) 2001:0db8:11aa:22bb:33cc:44ee:55ff:0006
    - 省) 2001:db8:11aa:22bb:33cc:44ee:55ff:6
  - 複数の16bitフィールドが続く場合は省略できる
    - 元）2001:0db8:0000:0000:0000:0000:55ff:0001
    - 省）2001:db8::55ff:1
  - ただし、「::」が使えるのは一箇所だけ
    - 元）2001:0db8:0000:0000:0000:0002:0000:0001
    - 省）2001:db8::2:0:1
  - IPv4アドレスを含む特殊なアドレス
    - 特殊なアドレス1
      - 元）0:0:0:0:0:13.1.68.3
      - 省）::13.1.68.3
    - 特殊なアドレス2
      - 元）0:0:0:0:FFFF:129.144.52.38
      - 省）::FFFF:129.144.52.38

#### 3.3.2 RFC5952のルール

- RFC4291だと いろいろな表記方法が混在できわかりにくい
  - ex) 以下はすべて同じアドレス
    - 2001:db8:0:0:1:0:0:1
    - 2001:0db8:0:0:1:0:0:1
    - 2001:db8::1:0:0:1
    - 2001:db8::0:1:0:0:1
    - 2001:0db8::1:0:0:1
    - 2001:db8:0:0:1::1
    - 2001:db8:0000:0:1::1
    - 2001:DB8:0:0:1::1
- これを統一表現できるようなルールを規定したのが RFC5952
- RFC5952 ルール
  - 「::」短縮時には可能な限り短くする
    - ...0:0:0:0:1 を ...::0:1 とはしない
  - 16bit の 0 が一つだけのときに「::」を利用してはならない
    - 1:0:2:... を 1::2 とはしない
  - 最も短縮できる箇所で「::」を使う
    - 0:0:1:0:0:0:2:3 → ::1:0:0:0:2:3 とはしない
    - 0:0:1::2:3 が正解
  - 同じ長さの16bitの0 がある場合最初の箇所で「::」を利用する
    - 0:0:1:0:0:2:3:4 → ::1:0:0:2:3:4
  - 16新表記はすべて小文字で
    - FFFF:::1 → ffff:1
  - 特殊なIPv6アドレスでの利用
    - ::ffff:192.0.2.1 のように先頭0は必ず省略する
  - ポート番号表記
    - [2001:db8::1]:80 ※推奨
    - 2001:db8::1:80 ※非推奨
    - 2001:db8::1.80
    - 2001:db8::1 port 80
    - 2001:db8::1p80
    - 2001:db8::1#80

#### 3.3.3 RFC5952のルールは人間向け

- RFC5952 は あくまでも人間向け
- アプリケーションレベルでは RFC4291 を正しく理解できるように作る必要がある

## 第4章 IPv6アドレス体型

- IPv6 のビットの並び方に意味をもたせる方法を解説するよ

### 4.1 IPv6アドレスの種類

- IPv6 アドレスの基本的な分類（RFC4291）
  - 未定義アドレス
  - ループバックアドレス
  - マルチキャストアドレス
  - リンクローカルユニキャストアドレス
  - グローバルユニキャストアドレス
- 未定義アドレス（::/128）
  - 128bit すべてが 0 となるIPv6アドレス 「::」 のこと
  - ノードに割り当てることはできない
  - ルータが転送することも禁止されている（受け取ったら破棄
  - おまけ）デフォルトゲートウェイの表現方法
    - IPv6  ::/128
    - IPv4 0.0.0.0/32
- ループバックアドレス（::1/128）
  - ::1 は 127.0.0.1 に相当するループバックアドレス
  - ループバックアドレスはノード内でのみ使用可能
  - ルータによる転送は禁止されている（受け取ったら破棄
- マルチキャストアドレス（ff00::/8）
  - いくつかのノードあてにまとめてパケットを送信するときに使用するアドレス
  - 先頭8bit 1 がマルチキャスト用アドレスとして確保
    - 同一リンク内の全ノード
      - ff02::1
      - 全ノードマルチキャストアドレス
    - 同一リンク内の全ルータ
      - ff02::2
      - 全ルータマルチキャストアドレス
- リンクローカルユニキャストアドレス（fe80::/10）
  - 同一リンク内でのみ利用可能なアドレス
- グローバルユニキャストアドレス
  - 上記以外のすべてのアドレス

### 4.2 IPv6アドレス空間の使い方はIANAが管理している

- IANAの管理ページ
- https://www.iana.org/assignments/ipv6-address-space/ipv6-address-space.xhtml
- グローバルユニキャスト
  - https://www.iana.org/assignments/ipv6-unicast-address-assignments/ipv6-unicast-address-assignments.xhtml
  - 現時点で グルーバルユニキャストアドレスとしてIANAで予約されているのは 2000::/3

### 4.3 IPv6におけるユニキャストアドレスの構成要素

- アドレス構成要素の違い
  - IPv4；ネットワーク部とホスト部
  - IPv6；ネットワーク部とインターフェース識別子
    - 1つのネットワークインターフェースに対して複数のIPv6がつくことが最初から想定されている
    - そのため ネットワークインターフェースを識別するものという前提
- IPv6 では １つのNICに IPv6アドレスを複数設定可能
  - サブネットプレフィックスが異なっていて
  - インターフェース識別子は同じ

### 4.4 IPv6 アドレスのスコープ

- IPv6 にはスコープという概念がある（RFC4007）
  - ユニキャストアドレス・エニーキャストアドレス
    - リンクローカルスコープ
    - グローバルスコープ
  - サイトローカルアドレス（廃止された
- スコープ
  - リンクローカルスコープ
    - 同一リンク内でのみ一意なIPv6アドレス
    - ループバックアドレスもリンクローカルスコープとして取り扱われる
  - グローバルスコープ
    - インターネット全体で一意なIPv6アドレス
- ゾーン
  - スコープに対する ゾーンという概念がある（4.7節で解説）

### 4.5 IPv6ノードに要求されるIPv6アドレス

- IPv6 はグローバルアドレスと同時にリンクローカルアドレスも必要
  - IPv6 はリンクローカルアドレスを要求するプロトコルがあるため
- IPv6ノードに要求されるIPv6アドレス（RFC4291
  - ホストに要求されるもの
    - 各NICごとにリンクローカルアドレスが必要
    - NICに対するユニキャストまたはエニーキャストアドレス
    - ループバックアドレス(::1/128）
    - 全ノードマルチキャストアドレス（ff02::1）
    - 各ユニキャスト、エニーキャストアドレスに対応するSolicited-Nodeマルチキャストアドレス（12.3節参照）
    - そのノードが参加するその他マルチキャストアドレス（12章参照）
  - ルータに要求されるもの
    - 上記のIPv6アドレス
    - ルータとしての機能を提供しているNICに対するサブネットルータエニーキャストアドレス（13.3節参照）
    - ルータに対して設定されるその他エニーキャストアドレス（13章参照）
    - 全ルータマルチキャストアドレス（ff02:2）
 
### 4.6 リンクローカルユニキャストアドレス

− リンクユニキャストアドレス
  − 同一リンク内でのみ利用可能な
  − リンクローカルスコープなIPv6アドレス
− すべてのNICにはリンクローカルユニキャストアドレスを設定する必要がある

− RFC4862
  − リンクローカルアドレスの精製方法が規定されている
  − 先頭10bitが `1111 110 10`  サブネットプレフィックスが0のアドレスを作る
  − インターフェース識別子の長さは任意(RFC4862)
  - RFC4862 インターフェース識別子の長さ 64bより大きくなることがありえない
